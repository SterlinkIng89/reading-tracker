---
import "../styles/global.css";
import BaseLayout from "../layout/BaseLayout.astro";

export const prerender = false;
---

<BaseLayout title="Login">
  <div class="min-h-[calc(100vh-4rem)] flex items-center justify-center px-4">
    <main class="w-full max-w-md bg-white rounded-lg shadow-md p-8">
      <h1 class="text-2xl font-semibold mb-6 text-center">
        Sign in to your account
      </h1>

      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Username</label
          >
          <input
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
            type="text"
            name="username"
            autocomplete="username"
            required
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Password</label
          >
          <input
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
            type="password"
            name="password"
            autocomplete="current-password"
            required
          />
        </div>

        <!-- moved console.log to client script to avoid server-side header access during prerender -->

        <div class="flex items-center justify-between">
          <a class="text-sm text-indigo-600 hover:underline" href="/register"
            >Create an account</a
          >
          <button
            type="submit"
            class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
            >Sign in</button
          >
        </div>
      </form>

      <div id="msg" class="mt-4 text-sm text-red-600"></div>
    </main>

    <script type="module">
      console.log("Login page script loaded");
      import { setTokens } from "../public/auth/auth.js";
      import apiRoutes from "../public/apis/apiRoutes.js";

      const form = document.getElementById("login-form");
      const msg = document.getElementById("msg");
      if (form instanceof HTMLFormElement && msg instanceof HTMLElement) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "";
          const formData = new FormData(form);
          const username = formData.get("username");
          const password = formData.get("password");
          const body = new URLSearchParams();
          if (typeof username === "string") body.append("username", username);
          if (typeof password === "string") body.append("password", password);
          try {
            const res = await fetch(apiRoutes.users.login, {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body,
            });
            if (!res.ok) throw new Error((await res.text()) || res.statusText);
            console.log("response", res);
            const data = await res.json();

            setTokens(data.access_token, null);
            window.location.replace("/dashboard");
          } catch (err) {
            msg.textContent =
              "Error: " + (err instanceof Error ? err.message : String(err));
          }
        });
      }
    </script>
  </div>
</BaseLayout>
